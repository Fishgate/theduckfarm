(function($){var Scroller,ajaxurl,stats,type,text,totop,timer,isIE=-1!=navigator.userAgent.search("MSIE");if(isIE)var IEVersion=navigator.userAgent.match(/MSIE\s?(\d+)\.?\d*;/),IEVersion=parseInt(IEVersion[1]);Scroller=function(e){var t=this;this.id=e.id;this.body=$(document.body);this.window=$(window);this.element=$("#"+e.id);this.wrapperClass=e.wrapper_class;this.ready=!0;this.disabled=!1;this.page=1;this.offset=e.offset;this.currentday=e.currentday;this.order=e.order;this.throttle=!1;this.handle='<div id="infinite-handle"><span>'+text.replace("\\","")+"</span></div>";this.google_analytics=e.google_analytics;this.history=e.history;this.origURL=window.location.href;this.footer=$("#infinite-footer");this.footer.wrap=e.footer;if(type=="scroll"){this.window.bind("scroll.infinity",function(){this.throttle=!0});t.gotop();setInterval(function(){if(this.throttle){this.throttle=!1;t.thefooter();t.refresh()}},300);t.ensureFilledViewport();this.body.bind("post-load",{self:t},t.checkViewportOnLoad)}else if(type=="click"){this.element.append(t.handle);this.element.delegate("#infinite-handle","click.infinity",function(){$("#infinite-handle").remove();t.refresh()})}};Scroller.prototype.check=function(){var e=this.window.scrollTop()+this.window.height(),t=this.element.offset().top+this.element.outerHeight(!1)-this.window.height();t=Math.round(t*.75);return e>t};Scroller.prototype.render=function(e){this.body.addClass("infinity-success");this.element.append(e.html);this.body.trigger("post-load");this.ready=!0};Scroller.prototype.query=function(){return{page:this.page,currentday:this.currentday,order:this.order,scripts:window.infiniteScroll.settings.scripts,styles:window.infiniteScroll.settings.styles,query_args:window.infiniteScroll.settings.query_args,last_post_date:window.infiniteScroll.settings.last_post_date}};Scroller.prototype.gotop=function(){var e=$("#infinity-blog-title");e.attr("title",totop);e.bind("click",function(e){$("html, body").animate({scrollTop:0},"fast");e.preventDefault()})};Scroller.prototype.thefooter=function(){var e=this,t;if($.type(this.footer.wrap)==="string"){t=$("body #"+this.footer.wrap).outerWidth(!1);t>479&&this.footer.find(".container").css("width",t)}this.window.scrollTop()>=350?e.footer.animate({bottom:0},"fast"):this.window.scrollTop()<350&&e.footer.animate({bottom:"-50px"},"fast")};Scroller.prototype.refresh=function(){var self=this,query,jqxhr,load,loader,color;if(this.disabled||!this.ready||!this.check())return;this.ready=!1;loader='<span class="infinite-loader"></span>';this.element.append(loader);loader=this.element.find(".infinite-loader");color=loader.css("color");try{loader.spin("medium-left",color)}catch(error){}query=$.extend({action:"infinite_scroll"},this.query());jqxhr=$.get(infiniteScroll.settings.ajaxurl,query);jqxhr.fail(function(){loader.hide();self.ready=!0});jqxhr.done(function(response){loader.hide();if(!response)return;response=$.parseJSON(response);if(!response||!response.type)return;if(response.type=="empty"){self.disabled=!0;self.body.addClass("infinity-end").removeClass("infinity-success")}else if(response.type=="success"){response.scripts&&$(response.scripts).each(function(){window.infiniteScroll.settings.scripts.push(this.handle);if(this.extra_data){var e=document.createElement("script"),t=document.createTextNode("//<![CDATA[ \n"+this.extra_data+"\n//]]>");e.type="text/javascript";e.appendChild(t);document.getElementsByTagName(this.footer?"body":"head")[0].appendChild(e)}var n=document.createElement("script");n.type="text/javascript";n.src=this.src;n.id=this.handle;document.getElementsByTagName(this.footer?"body":"head")[0].appendChild(n)});response.styles&&$(response.styles).each(function(){window.infiniteScroll.settings.styles.push(this.handle);var style=document.createElement("link");style.rel="stylesheet";style.href=this.src;style.id=this.handle+"-css";if(this.conditional&&(!isIE||!eval(this.conditional.replace(/%ver/g,IEVersion))))var style=!1;style&&document.getElementsByTagName("head")[0].appendChild(style)});self.page++;stats&&((new Image).src=document.location.protocol+"//stats.wordpress.com/g.gif?"+stats+"&post=0&baba="+Math.random());"object"==typeof response.postflair&&"object"==typeof WPCOM_sharing_counts&&(WPCOM_sharing_counts=$.extend(WPCOM_sharing_counts,response.postflair));self.render.apply(self,arguments);type=="click"&&!response.lastbatch&&self.element.append(self.handle);response.currentday&&(self.currentday=response.currentday);self.google_analytics&&"object"==typeof _gaq&&_gaq.push(["_trackPageview",self.history.path.replace(/%d/,self.page)])}});return jqxhr};Scroller.prototype.ensureFilledViewport=function(){var e=this,t=e.window.height(),n=e.element.height();aveSetHeight=0,wrapperQty=0;if(n===0){$(e.element.selector+" > li").each(function(){n+=$(this).height()});if(n===0){e.body.unbind("post-load",e.checkViewportOnLoad);return}}$("."+e.wrapperClass).each(function(){aveSetHeight+=$(this).height();wrapperQty++});wrapperQty>0?aveSetHeight/=wrapperQty:aveSetHeight=0;if(n<t&&n+aveSetHeight<t){e.ready=!0;e.refresh()}else e.body.unbind("post-load",e.checkViewportOnLoad)};Scroller.prototype.checkViewportOnLoad=function(e){e.data.self.ensureFilledViewport()};Scroller.prototype.determineURL=function(){var e=window.infiniteScroll.scroller,t=$(window).scrollTop(),n=t+$(window).height(),r=n-t,i=[],s=!1;$("."+e.wrapperClass).each(function(){var e=$(this).attr("id"),r=$(this).offset().top,s=$(this).outerHeight(!1),o=0,u=$(this).data("page-num");0==s&&$("> *",this).each(function(){s+=$(this).outerHeight(!1)});o=r+s;r<t&&o>n?i.push({id:e,top:r,bottom:o,pageNum:u}):r>t&&r<n?i.push({id:e,top:r,bottom:o,pageNum:u}):o>t&&o<n&&i.push({id:e,top:r,bottom:o,pageNum:u})});if(0==i.length)s=-1;else if(1==i.length){var o=i.pop();(n-o.top)/r<.5?s=-1:s=o.pageNum}else{var u=0;$.each(i,function(e,i){var o=0,a=0,f=0;i.top>t&&i.top<n&&(o=(n-i.top)/r);i.bottom>t&&i.bottom<n&&(a=(i.bottom-t)/r);o>=a?f=o:a>=o&&(f=a);if(f>u){s=i.pageNum;u=f}})}if("number"==typeof s){s!=-1&&s++;e.updateURL(s)}};Scroller.prototype.updateURL=function(e){var t=this,n=t.offset>0?t.offset-1:0,r=-1==e?t.origURL:window.location.protocol+"//"+t.history.host+t.history.path.replace(/%d/,e+n)+t.history.parameters;window.location.href!=r&&history.pushState(null,null,r)};$(document).ready(function(){if("object"!=typeof infiniteScroll)return;ajaxurl=infiniteScroll.settings.ajaxurl;stats=infiniteScroll.settings.stats;type=infiniteScroll.settings.type;text=infiniteScroll.settings.text;totop=infiniteScroll.settings.totop;infiniteScroll.scroller=new Scroller(infiniteScroll.settings);(!isIE||isIE&&IEVersion>=10)&&$(window).bind("scroll",function(){clearTimeout(timer);timer=setTimeout(infiniteScroll.scroller.determineURL,100)})})})(jQuery);