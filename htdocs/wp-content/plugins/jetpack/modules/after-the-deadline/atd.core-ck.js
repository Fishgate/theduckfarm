/*
 * atd.core.js - A building block to create a front-end for AtD
 * Author      : Raphael Mudge, Automattic
 * License     : LGPL
 * Project     : http://www.afterthedeadline.com/developers.slp
 * Contact     : raffi@automattic.com
 *//* EXPORTED_SYMBOLS is set so this file can be a JavaScript Module */function AtDCore(){this.ignore_types=["Bias Language","Cliches","Complex Expression","Diacritical Marks","Double Negatives","Hidden Verbs","Jargon Language","Passive voice","Phrases to Avoid","Redundant Expression"];this.ignore_strings={};this.i18n={}}function TokenIterator(e){this.tokens=e;this.index=0;this.count=0;this.last=0}function atd_sprintf(e,t){var n=e;for(var r=0;r<t.length;r++)n=n.replace(new RegExp("%"+(r+1)+"\\$","g"),t[r]);return n}var EXPORTED_SYMBOLS=["AtDCore"];AtDCore.prototype.getLang=function(e,t){return window.AtD_l10n_r0ar&&window.AtD_l10n_r0ar[e]||t};AtDCore.prototype.addI18n=function(e){window.AtD_l10n_r0ar=e};AtDCore.prototype.setIgnoreStrings=function(e){var t=this;this.map(e.split(/,\s*/g),function(e){t.ignore_strings[e]=1})};AtDCore.prototype.showTypes=function(e){var t=e.split(/,\s*/g),n={};n["Double Negatives"]=1;n["Hidden Verbs"]=1;n["Passive voice"]=1;n["Bias Language"]=1;n.Cliches=1;n["Complex Expression"]=1;n["Diacritical Marks"]=1;n["Jargon Language"]=1;n["Phrases to Avoid"]=1;n["Redundant Expression"]=1;var r=[];this.map(t,function(e){n[e]=undefined});this.map(this.ignore_types,function(e){n[e]!=undefined&&r.push(e)});this.ignore_types=r};AtDCore.prototype.makeError=function(e,t,n,r,i){var s=new Object;s.type=n;s.string=e;s.tokens=t;(new RegExp("\\b"+e+"\\b")).test(e)?s.regexp=new RegExp("(?!"+e+"<)\\b"+e.replace(/\s+/g,r)+"\\b"):(new RegExp(e+"\\b")).test(e)?s.regexp=new RegExp("(?!"+e+"<)"+e.replace(/\s+/g,r)+"\\b"):(new RegExp("\\b"+e)).test(e)?s.regexp=new RegExp("(?!"+e+"<)\\b"+e.replace(/\s+/g,r)):s.regexp=new RegExp("(?!"+e+"<)"+e.replace(/\s+/g,r));s.used=!1;return s};AtDCore.prototype.addToErrorStructure=function(e,t,n,r){var i=this;this.map(t,function(t){var s=t.word.split(/\s+/),o=t.pre,u=s[0];if(e["__"+u]==undefined){e["__"+u]=new Object;e["__"+u].pretoks={};e["__"+u].defaults=new Array}if(o=="")e["__"+u].defaults.push(i.makeError(t.word,s,n,r,o));else{e["__"+u].pretoks["__"+o]==undefined&&(e["__"+u].pretoks["__"+o]=new Array);e["__"+u].pretoks["__"+o].push(i.makeError(t.word,s,n,r,o))}})};AtDCore.prototype.buildErrorStructure=function(e,t,n){var r=this._getSeparators(),i={};this.addToErrorStructure(i,e,"hiddenSpellError",r);this.addToErrorStructure(i,n,"hiddenGrammarError",r);this.addToErrorStructure(i,t,"hiddenSuggestion",r);return i};AtDCore.prototype._getSeparators=function(){var e="",t,n='"s!#$%&()*+,./:;<=>?@[]^_{|}';for(t=0;t<n.length;t++)e+="\\"+n.charAt(t);return"(?:(?:[Â "+e+"])|(?:\\-\\-))+"};AtDCore.prototype.processXML=function(e){var t={};this.map(this.ignore_types,function(e){t[e]=1});this.suggestions=[];var n=e.getElementsByTagName("error"),r=[],i=[],s=[];for(var o=0;o<n.length;o++)if(n[o].getElementsByTagName("string").item(0).firstChild!=null){var u=n[o].getElementsByTagName("string").item(0).firstChild.data,a=n[o].getElementsByTagName("type").item(0).firstChild.data,f=n[o].getElementsByTagName("description").item(0).firstChild.data,l;n[o].getElementsByTagName("precontext").item(0).firstChild!=null?l=n[o].getElementsByTagName("precontext").item(0).firstChild.data:l="";if(this.ignore_strings[u]==undefined){var c={};c.description=f;c.suggestions=[];c.matcher=new RegExp("^"+u.replace(/\s+/,this._getSeparators())+"$");c.context=l;c.string=u;c.type=a;this.suggestions.push(c);if(n[o].getElementsByTagName("suggestions").item(0)!=undefined){var h=n[o].getElementsByTagName("suggestions").item(0).getElementsByTagName("option");for(var p=0;p<h.length;p++)c.suggestions.push(h[p].firstChild.data)}if(n[o].getElementsByTagName("url").item(0)!=undefined){var d=n[o].getElementsByTagName("url").item(0).firstChild.data;c.moreinfo=d+"&theme=tinymce"}if(t[f]==undefined){a=="suggestion"&&s.push({word:u,pre:l});a=="grammar"&&r.push({word:u,pre:l})}(a=="spelling"||f=="Homophone")&&i.push({word:u,pre:l});f=="Cliches"&&(c.description="Clich&eacute;s");f=="Spelling"&&(c.description=this.getLang("menu_title_spelling","Spelling"));f=="Repeated Word"&&(c.description=this.getLang("menu_title_repeated_word","Repeated Word"));f=="Did you mean..."&&(c.description=this.getLang("menu_title_confused_word","Did you mean..."))}}var v,m=i.length+r.length+s.length;m>0?v=this.buildErrorStructure(i,s,r):v=undefined;return{errors:v,count:m,suggestions:this.suggestions}};AtDCore.prototype.findSuggestion=function(e){var t=e.innerHTML,n=(this.getAttrib(e,"pre")+"").replace(/[\\,!\\?\\."\s]/g,"");this.getAttrib(e,"pre")==undefined&&alert(e.innerHTML);var r=undefined,i=this.suggestions.length;for(var s=0;s<i;s++){var o=this.suggestions[s].string;if((n==""||n==this.suggestions[s]["context"])&&this.suggestions[s].matcher.test(t)){r=this.suggestions[s];break}}return r};TokenIterator.prototype.next=function(){var e=this.tokens[this.index];this.count=this.last;this.last+=e.length+1;this.index++;if(e!=""){e[0]=="'"&&(e=e.substring(1,e.length));e[e.length-1]=="'"&&(e=e.substring(0,e.length-1))}return e};TokenIterator.prototype.hasNext=function(){return this.index<this.tokens.length};TokenIterator.prototype.hasNextN=function(e){return this.index+e<this.tokens.length};TokenIterator.prototype.skip=function(e,t){this.index+=e;this.last+=t;this.index<this.tokens.length&&(this.count=this.last-this.tokens[this.index].length)};TokenIterator.prototype.getCount=function(){return this.count};TokenIterator.prototype.peek=function(e){var t=new Array,n=this.index+e;for(var r=this.index;r<n;r++)t.push(this.tokens[r]);return t};AtDCore.prototype.markMyWords=function(e,t){var n=new RegExp(this._getSeparators()),r=new Array,i=0,s=this,o=this._isTinyMCE?' data-mce-bogus="1"':"",u='<span class="mceItemHidden"'+o+">&nbsp;</span>";this._walk(e,function(e){e.nodeType==3&&!s.isMarkedNode(e)&&r.push(e)});var a;this.map(r,function(e){var r;if(e.nodeType==3){r=e.nodeValue;var f=e.nodeValue.split(n),l="",c=[];a=new TokenIterator(f);while(a.hasNext()){var h=a.next(),p=t["__"+h],d;if(p!=undefined&&p.pretoks!=undefined){d=p.defaults;p=p.pretoks["__"+l];var v=!1,m,g;m=r.substr(0,a.getCount());g=r.substr(m.length,r.length);var y=function(e){if(e!=undefined&&!e.used&&b["__"+e.string]==undefined&&e.regexp.test(g)){var t=g.length;b["__"+e.string]=1;c.push([e.regexp,'<span class="'+e.type+'" pre="'+l+'"'+o+">$&</span>"]);e.used=!0;v=!0}},b={};if(p!=undefined){l+=" ";s.map(p,y)}if(!v){l="";s.map(d,y)}}l=h}if(c.length>0){newNode=e;for(var w=0;w<c.length;w++){var E=c[w][0],S=c[w][1],x=function(e){if(e.nodeType==3){i++;return s.isIE()&&e.nodeValue.length>0&&e.nodeValue.substr(0,1)==" "?s.create(u+e.nodeValue.substr(1,e.nodeValue.length-1).replace(E,S),!1):s.create(e.nodeValue.replace(E,S),!1)}var t=s.contents(e);for(var n=0;n<t.length;n++)if(t[n].nodeType==3&&E.test(t[n].nodeValue)){var r;s.isIE()&&t[n].nodeValue.length>0&&t[n].nodeValue.substr(0,1)==" "?r=s.create(u+t[n].nodeValue.substr(1,t[n].nodeValue.length-1).replace(E,S),!0):r=s.create(t[n].nodeValue.replace(E,S),!0);s.replaceWith(t[n],r);s.removeParent(r);i++;return e}return e};newNode=x(newNode)}s.replaceWith(e,newNode)}}});return i};AtDCore.prototype._walk=function(e,t){var n;for(n=0;n<e.length;n++){t.call(t,e[n]);this._walk(this.contents(e[n]),t)}};AtDCore.prototype.removeWords=function(e,t){var n=0,r=this;this.map(this.findSpans(e).reverse(),function(e){if(e&&(r.isMarkedNode(e)||r.hasClass(e,"mceItemHidden")||r.isEmptySpan(e)))if(e.innerHTML=="&nbsp;"){var i=document.createTextNode(" ");r.replaceWith(e,i)}else if(!t||e.innerHTML==t){r.removeParent(e);n++}});return n};AtDCore.prototype.isEmptySpan=function(e){return this.getAttrib(e,"class")==""&&this.getAttrib(e,"style")==""&&this.getAttrib(e,"id")==""&&!this.hasClass(e,"Apple-style-span")&&this.getAttrib(e,"mce_name")==""};AtDCore.prototype.isMarkedNode=function(e){return this.hasClass(e,"hiddenGrammarError")||this.hasClass(e,"hiddenSpellError")||this.hasClass(e,"hiddenSuggestion")};AtDCore.prototype.applySuggestion=function(e,t){if(t=="(omit)")this.remove(e);else{var n=this.create(t);this.replaceWith(e,n);this.removeParent(n)}};AtDCore.prototype.hasErrorMessage=function(e){return e!=undefined&&e.getElementsByTagName("message").item(0)!=null};AtDCore.prototype.getErrorMessage=function(e){return e.getElementsByTagName("message").item(0)};AtDCore.prototype.isIE=function(){return navigator.appName=="Microsoft Internet Explorer"};