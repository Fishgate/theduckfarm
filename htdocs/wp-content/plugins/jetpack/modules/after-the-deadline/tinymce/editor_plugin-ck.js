/*
 * TinyMCE Writing Improvement Tool Plugin
 * Author: Raphael Mudge (raffi@automattic.com)
 *
 * http://www.afterthedeadline.com
 *
 * Distributed under the LGPL
 *
 * Derived from:
 *    $Id: editor_plugin_src.js 425 2007-11-21 15:17:39Z spocke $
 *
 *    @author Moxiecode
 *    @copyright Copyright (C) 2004-2008, Moxiecode Systems AB, All rights reserved.
 *
 *    Moxiecode Spell Checker plugin released under the LGPL with TinyMCE
 */(function(){function i(e,t){return window.AtD_l10n_r0ar&&window.AtD_l10n_r0ar[e]||t}var e=tinymce.util.JSONRequest,t=tinymce.each,n=tinymce.DOM,r;tinymce.create("tinymce.plugins.AfterTheDeadlinePlugin",{getInfo:function(){return{longname:"After The Deadline",author:"Raphael Mudge",authorurl:"http://blog.afterthedeadline.com",infourl:"http://www.afterthedeadline.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}},initAtDCore:function(e,n){var r=new AtDCore;r.map=t;r.getAttrib=function(t,n){return e.dom.getAttrib(t,n)};r.findSpans=function(t){return t==undefined?e.dom.select("span"):e.dom.select("span",t)};r.hasClass=function(t,n){return e.dom.hasClass(t,n)};r.contents=function(e){return e.childNodes};r.replaceWith=function(t,n){return e.dom.replace(n,t)};r.create=function(t){return e.dom.create("span",{"class":"mceItemHidden"},t)};r.removeParent=function(t){e.dom.remove(t,1);return t};r.remove=function(t){e.dom.remove(t)};r.setIgnoreStrings(e.getParam("atd_ignore_strings",[]).join(","));r.showTypes(e.getParam("atd_show_types",""));return r},init:function(e,n){if(typeof AtDCore=="undefined")return;var s=this,o=this,u=e;this.url=n;this.editor=e;r=e.core=this.initAtDCore(u,o);var a=tinymce.util.Cookie.getHash("atd_ignore");a==undefined&&(a={});u.addCommand("mceWritingImprovementTool",function(t){typeof AtD_proofread_click_count!="undefined"&&AtD_proofread_click_count++;o.editor.setProgressState(1);o._removeWords();o.sendRequest("checkDocument",e.getContent({format:"raw"}),function(n,s,u){o.editor.setProgressState(0);if(s.status!=200||s.responseText.substr(1,4)=="html"||!s.responseXML){e.windowManager.alert(i("message_server_error","There was a problem communicating with the Proofreading service. Try again in one minute."),t?function(){t(0)}:function(){});return}if(s.responseXML.getElementsByTagName("message").item(0)!=null){e.windowManager.alert(s.responseXML.getElementsByTagName("message").item(0).firstChild.data,t?function(){t(0)}:function(){});return}var a=r.processXML(s.responseXML),f=0;if(a.count>0){f=o.markMyWords(a.errors);e.suggestions=a.suggestions}f!=0||!!t&&t!=undefined?t&&t(f):e.windowManager.alert(i("message_no_errors_found","No writing errors were found."))})});u.onInit.add(function(){u.settings.content_css!==!1&&u.dom.loadCSS(u.getParam("atd_css_url",n+"/css/content.css"))});u.onClick.add(o._showMenu,o);u.onContextMenu.add(o._showMenu,o);u.onPreProcess.add(function(e,n){var r=e.dom;t(r.select("span",n.node).reverse(),function(e){e&&(r.hasClass(e,"hiddenGrammarError")||r.hasClass(e,"hiddenSpellError")||r.hasClass(e,"hiddenSuggestion")||r.hasClass(e,"mceItemHidden")||r.getAttrib(e,"class")==""&&r.getAttrib(e,"style")==""&&r.getAttrib(e,"id")==""&&!r.hasClass(e,"Apple-style-span")&&r.getAttrib(e,"mce_name")=="")&&r.remove(e,1)})});u.onBeforeExecCommand.add(function(e,t){t=="mceCodeEditor"?o._removeWords():t=="mceFullScreen"&&o._done()});e.addButton("AtD",{title:i("button_proofread_tooltip","Proofread Writing"),image:e.getParam("atd_button_url",n+"/atdbuttontr.gif"),cmd:"mceWritingImprovementTool"})},_removeWords:function(e){var t=this.editor,n=t.dom,r=t.selection,i=r.getBookmark();t.core.removeWords(undefined,e);n.setHTML(n.getRoot(),n.getRoot().innerHTML);r.moveToBookmark(i)},markMyWords:function(e){var t=this.editor,n=t.selection,r=n.getBookmark(),i=t.core.markMyWords(t.core.contents(this.editor.getBody()),e);n.moveToBookmark(r);return i},_showMenu:function(e,t){var r=this,e=r.editor,s=r._menu,o,u=e.dom,a=u.getViewPort(e.getWin()),f=this;if(!s){o=n.getPos(e.getContentAreaContainer());s=e.controlManager.createDropMenu("spellcheckermenu",{offset_x:o.x,offset_y:o.y,"class":"mceNoIcons"});r._menu=s}if(e.core.isMarkedNode(t.target)){s.removeAll();var l=e.core.findSuggestion(t.target);if(l==undefined)s.add({title:i("menu_title_no_suggestions","No suggestions"),"class":"mceMenuItemTitle"}).setDisabled(1);else if(l["suggestions"].length==0)s.add({title:l.description,"class":"mceMenuItemTitle"}).setDisabled(1);else{s.add({title:l.description,"class":"mceMenuItemTitle"}).setDisabled(1);for(var c=0;c<l.suggestions.length;c++)(function(n){s.add({title:n,onclick:function(){e.core.applySuggestion(t.target,n);r._checkDone()}})})(l.suggestions[c]);s.addSeparator()}if(l!=undefined&&l["moreinfo"]!=null){(function(t){s.add({title:i("menu_option_explain","Explain..."),onclick:function(){e.windowManager.open({url:t,width:480,height:380,inline:!0},{theme_url:this.url})}})})(l.moreinfo);s.addSeparator()}s.add({title:i("menu_option_ignore_once","Ignore suggestion"),onclick:function(){u.remove(t.target,1);r._checkDone()}});String(this.editor.getParam("atd_ignore_enable","false"))=="true"?s.add({title:i("menu_option_ignore_always","Ignore always"),onclick:function(){var e=r.editor.getParam("atd_ignore_rpc_url","{backend}");if(e=="{backend}"){var n=tinymce.util.Cookie.getHash("atd_ignore");n==undefined&&(n={});n[t.target.innerHTML]=1;tinymce.util.Cookie.setHash("atd_ignore",n,new Date((new Date).getTime()+15768e7))}else{var i=r.editor.getParam("atd_rpc_id","12345678");tinymce.util.XHR.send({url:e+encodeURI(t.target.innerHTML).replace(/&/g,"%26")+"&key="+i,content_type:"text/xml",async:!0,type:"GET",success:function(e,t,n){},error:function(e,t,n){alert("Ignore preference save failed\n"+e+"\n"+t.status+"\nAt: "+n.url)}});r.editor.core.setIgnoreStrings(t.target.innerHTML)}r._removeWords(t.target.innerHTML);r._checkDone()}}):s.add({title:i("menu_option_ignore_all","Ignore all"),onclick:function(){r._removeWords(t.target.innerHTML);r._checkDone()}});e.selection.select(t.target);o=u.getPos(t.target);s.showMenu(o.x,o.y+t.target.offsetHeight-a.y);return tinymce.dom.Event.cancel(t)}s.hideMenu()},_checkDone:function(){var e=this,n=e.editor,r=n.dom,i;t(r.select("span"),function(e){if(e&&r.hasClass(e,"mceItemHidden")){i=!0;return!1}});i||e._done()},_done:function(){var e=this;e._removeWords();e._menu&&e._menu.hideMenu();e.editor.nodeChanged()},sendRequest:function(e,t,n){var r=this.editor.getParam("atd_rpc_id","12345678"),i=this.editor.getParam("atd_rpc_url","{backend}"),s=this;if(i=="{backend}"||r=="12345678"){this.editor.setProgressState(0);alert("Please specify: atd_rpc_url and atd_rpc_id");return}tinymce.util.XHR.send({url:i+"/"+e,content_type:"text/xml",type:"POST",data:"data="+encodeURI(t).replace(/&/g,"%26")+"&key="+r,async:!0,success:n,error:function(e,t,n){s.editor.setProgressState(0);alert(e+"\n"+t.status+"\nAt: "+n.url)}})}});tinymce.PluginManager.add("AtD",tinymce.plugins.AfterTheDeadlinePlugin)})();