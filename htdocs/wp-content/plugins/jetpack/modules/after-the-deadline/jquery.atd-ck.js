/*
 * jquery.atd.js - jQuery powered writing check with After the Deadline
 * Author      : Raphael Mudge, Automattic Inc.
 * License     : LGPL or MIT License (take your pick)
 * Project     :  http://www.afterthedeadline.com/development.slp
 * Contact     : raffi@automattic.com
 *
 * Derived from:
 *
 * jquery.spellchecker.js - a simple jQuery Spell Checker
 * Copyright (c) 2008 Richard Willis
 * MIT license  : http://www.opensource.org/licenses/mit-license.php
 * Project      : http://jquery-spellchecker.googlecode.com
 * Contact      : willis.rh@gmail.com
 */var AtD={rpc:"",rpc_css:"http://www.polishmywriting.com/atd-jquery/server/proxycss.php?data=",rpc_css_lang:"en",api_key:"",i18n:{},listener:{}};AtD.getLang=function(e,t){return window.AtD_l10n_r0ar&&window.AtD_l10n_r0ar[e]||t};AtD.addI18n=function(e){window.AtD_l10n_r0ar=e};AtD.setIgnoreStrings=function(e){AtD.core.setIgnoreStrings(e)};AtD.showTypes=function(e){AtD.core.showTypes(e)};AtD.checkCrossAJAX=function(e,t){typeof AtD_proofread_click_count!="undefined"&&AtD_proofread_click_count++;AtD.callback_f=t;AtD.remove(e);var n=jQuery("#"+e),r=n.html();text=jQuery.trim(n.html());text=text.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&amp;/g,"&");text=encodeURIComponent(text.replace(/\%/g,"%25"));if(text.length>2e3&&navigator.appName=="Microsoft Internet Explorer"||text.length>7800){t!=undefined&&t.error!=undefined&&t.error("Maximum text length for this browser exceeded");return}CSSHttpRequest.get(AtD.rpc_css+text+"&lang="+AtD.rpc_css_lang+"&nocache="+(new Date).getTime(),function(t){var n;if(navigator.appName=="Microsoft Internet Explorer"){n=new ActiveXObject("Microsoft.XMLDOM");n.async=!1;n.loadXML(t)}else n=(new DOMParser).parseFromString(t,"text/xml");if(AtD.core.hasErrorMessage(n)){AtD.callback_f!=undefined&&AtD.callback_f.error!=undefined&&AtD.callback_f.error(AtD.core.getErrorMessage(n));return}AtD.container=e;var r=AtD.processXML(e,n);AtD.callback_f!=undefined&&AtD.callback_f.ready!=undefined&&AtD.callback_f.ready(r);r==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(r);AtD.counter=r;AtD.count=r})};AtD.check=function(e,t){typeof AtD_proofread_click_count!="undefined"&&AtD_proofread_click_count++;AtD.callback_f=t;AtD.remove(e);var n=jQuery("#"+e),r=n.html();text=jQuery.trim(n.html());text=text.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&amp;/g,"&");text=encodeURIComponent(text);jQuery.ajax({type:"POST",url:AtD.rpc+"/checkDocument",data:"key="+AtD.api_key+"&data="+text,format:"raw",dataType:jQuery.browser.msie?"text":"xml",error:function(e,t,n){AtD.callback_f!=undefined&&AtD.callback_f.error!=undefined&&AtD.callback_f.error(t+": "+n)},success:function(t){var n;if(typeof t=="string"){n=new ActiveXObject("Microsoft.XMLDOM");n.async=!1;n.loadXML(t)}else n=t;if(AtD.core.hasErrorMessage(n)){AtD.callback_f!=undefined&&AtD.callback_f.error!=undefined&&AtD.callback_f.error(AtD.core.getErrorMessage(n));return}AtD.container=e;var r=AtD.processXML(e,n);AtD.callback_f!=undefined&&AtD.callback_f.ready!=undefined&&AtD.callback_f.ready(r);r==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(r);AtD.counter=r;AtD.count=r}})};AtD.remove=function(e){AtD._removeWords(e,null)};AtD.clickListener=function(e){AtD.core.isMarkedNode(e.target)&&AtD.suggest(e.target)};AtD.processXML=function(e,t){var n=AtD.core.processXML(t);n.count>0&&(n.count=AtD.core.markMyWords(jQuery("#"+e).contents(),n.errors));jQuery("#"+e).unbind("click",AtD.clickListener);jQuery("#"+e).click(AtD.clickListener);return n.count};AtD.useSuggestion=function(e){this.core.applySuggestion(AtD.errorElement,e);AtD.counter--;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count)};AtD.editSelection=function(){var e=AtD.errorElement.parent();AtD.callback_f!=undefined&&AtD.callback_f.editSelection!=undefined&&AtD.callback_f.editSelection(AtD.errorElement);if(AtD.errorElement.parent()!=e){AtD.counter--;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count)}};AtD.ignoreSuggestion=function(){AtD.core.removeParent(AtD.errorElement);AtD.counter--;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count)};AtD.ignoreAll=function(e){var t=AtD.errorElement.text(),n=AtD._removeWords(e,t);AtD.counter-=n;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count);if(AtD.callback_f!=undefined&&AtD.callback_f.ignore!=undefined){AtD.callback_f.ignore(t);AtD.core.setIgnoreStrings(t)}};AtD.explainError=function(){AtD.callback_f!=undefined&&AtD.callback_f.explain!=undefined&&AtD.callback_f.explain(AtD.explainURL)};AtD.suggest=function(e){if(jQuery("#suggestmenu").length==0){var t=jQuery('<div id="suggestmenu"></div>');t.prependTo("body")}else{var t=jQuery("#suggestmenu");t.hide()}errorDescription=AtD.core.findSuggestion(e);AtD.errorElement=jQuery(e);t.empty();if(errorDescription==undefined)t.append("<strong>"+AtD.getLang("menu_title_no_suggestions","No suggestions")+"</strong>");else if(errorDescription["suggestions"].length==0)t.append("<strong>"+errorDescription.description+"</strong>");else{t.append("<strong>"+errorDescription.description+"</strong>");for(var n=0;n<errorDescription.suggestions.length;n++)(function(e){t.append("<a href=\"javascript:AtD.useSuggestion('"+e.replace(/'/,"\\'")+"')\">"+e+"</a>")})(errorDescription.suggestions[n])}if(AtD.callback_f!=undefined&&AtD.callback_f.explain!=undefined&&errorDescription["moreinfo"]!=undefined){t.append('<a href="javascript:AtD.explainError()" class="spell_sep_top">'+AtD.getLang("menu_option_explain","Explain...")+"</a>");AtD.explainURL=errorDescription.moreinfo}t.append('<a href="javascript:AtD.ignoreSuggestion()" class="spell_sep_top">'+AtD.getLang("menu_option_ignore_once","Ignore suggestion")+"</a>");if(AtD.callback_f!=undefined&&AtD.callback_f.editSelection!=undefined){AtD.callback_f!=undefined&&AtD.callback_f.ignore!=undefined?t.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+"')\">"+AtD.getLang("menu_option_ignore_always","Ignore always")+"</a>"):t.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+"')\">"+AtD.getLang("menu_option_ignore_all","Ignore all")+"</a>");t.append("<a href=\"javascript:AtD.editSelection('"+AtD.container+'\')" class="spell_sep_bottom spell_sep_top">'+AtD.getLang("menu_option_edit_selection","Edit Selection...")+"</a>")}else AtD.callback_f!=undefined&&AtD.callback_f.ignore!=undefined?t.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+'\')" class="spell_sep_bottom">'+AtD.getLang("menu_option_ignore_always","Ignore always")+"</a>"):t.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+'\')" class="spell_sep_bottom">'+AtD.getLang("menu_option_ignore_all","Ignore all")+"</a>");var r=jQuery(e).offset(),i=jQuery(e).width();i>100&&(i=50);jQuery(t).css({left:r.left+i+"px",top:r.top+"px"});jQuery(t).fadeIn(200);AtD.suggestShow=!0;setTimeout(function(){jQuery("body").bind("click",function(){AtD.suggestShow||jQuery("#suggestmenu").fadeOut(200)})},1);setTimeout(function(){AtD.suggestShow=!1},2)};AtD._removeWords=function(e,t){return this.core.removeWords(jQuery("#"+e),t)};AtD.initCoreModule=function(){var e=new AtDCore;e.hasClass=function(e,t){return jQuery(e).hasClass(t)};e.map=jQuery.map;e.contents=function(e){return jQuery(e).contents()};e.replaceWith=function(e,t){return jQuery(e).replaceWith(t)};e.findSpans=function(e){return jQuery.makeArray(e.find("span"))};e.create=function(t,n){t=t.replace(/\&/g,"&amp;");t=t.replace(/\</g,"&lt;").replace(/\>/g,"&gt;");var r=t.match(/\&lt;span class="hidden\w+?" pre="[^"]*"\&gt;.*?\&lt;\/span\&gt;/g);if(r)for(var i=0;i<r.length;i++)t=t.replace(r[i],r[i].replace(/\&lt;/gi,"<").replace(/\&gt;/gi,">"));if(e.isIE()){r=t.match(/\&lt;span class="mceItemHidden"\&gt;\&amp;nbsp;\&lt;\/span&gt;/g,t);if(r)for(var i=0;i<r.length;i++)t=t.replace(r[i],r[i].replace(/\&lt;/gi,"<").replace(/\&gt;/gi,">").replace(/\&amp;/gi,"&"))}node=jQuery('<span class="mceItemHidden"></span>');node.html(t);return node};e.remove=function(e){return jQuery(e).remove()};e.removeParent=function(e){return jQuery(e).unwrap?jQuery(e).contents().unwrap():jQuery(e).replaceWith(jQuery(e).html())};e.getAttrib=function(e,t){return jQuery(e).attr(t)};return e};AtD.core=AtD.initCoreModule();